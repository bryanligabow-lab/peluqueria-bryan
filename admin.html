<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Disponibilidad - Peluquería de Bryan</title>
  <style>
    body{margin:0;min-height:100vh;display:flex;justify-content:center;align-items:center;background:#07090d;color:#fff;font-family:system-ui;padding:20px}
    .card{max-width:760px;width:100%;background:rgba(17,24,39,.82);border:1px solid rgba(255,255,255,.12);border-radius:18px;padding:22px}
    label{display:block;margin-top:12px;font-size:13px}
    input,select{width:100%;margin-top:6px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:#fff}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){.grid{grid-template-columns:1fr}}
    button{width:100%;margin-top:14px;padding:12px;border-radius:14px;border:0;font-weight:900;cursor:pointer;background:linear-gradient(135deg,#d4af37,#b88a10);color:#1a1406}
    .ok,.err{display:none;margin-top:12px;padding:10px;border-radius:12px;font-weight:900}
    .ok{background:rgba(34,197,94,.2);border:1px solid rgba(34,197,94,.45)}
    .err{background:rgba(239,68,68,.18);border:1px solid rgba(239,68,68,.45)}
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 6px">Admin - Disponibilidad</h2>
    <div style="opacity:.75;font-size:13px">Define los horarios disponibles por barbero y fecha.</div>

    <label>PIN Admin</label>
    <input id="pin" placeholder="Tu PIN (ej 1234)" />

    <div class="grid">
      <div>
        <label>Barbero</label>
        <select id="barbero"></select>
      </div>
      <div>
        <label>Fecha</label>
        <input id="fecha" type="date" />
      </div>
      <div>
        <label>Desde</label>
        <input id="start" type="time" value="09:00" />
      </div>
      <div>
        <label>Hasta</label>
        <input id="end" type="time" value="20:00" />
      </div>
      <div>
        <label>Intervalo (min)</label>
        <input id="interval" type="number" value="30" min="10" max="120" />
      </div>
      <div>
        <label>Reemplazar disponibilidad del día</label>
        <select id="replace">
          <option value="true">SI (borrar y volver a crear)</option>
          <option value="false">NO (solo agregar)</option>
        </select>
      </div>
    </div>

    <button id="save">Guardar disponibilidad</button>

    <div id="ok" class="ok">✅ Guardado.</div>
    <div id="err" class="err">❌ Error.</div>
  </div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxWpXdGqiPiAuNb7c3-IKjisDpXn_6phyEstoYb2wGWq8GyA32a0fqbuKBCmQsuohWC/exec";

const $ = (id)=>document.getElementById(id);
const show = (el)=>el.style.display="block";
const hide = (el)=>el.style.display="none";

function api(payload){
  return new Promise((resolve) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    window[cb] = (data) => {
      try { delete window[cb]; } catch(e) { window[cb] = undefined; }
      script.remove();
      resolve(data);
    };

    const qs = new URLSearchParams(payload).toString();
    const url = `${WEB_APP_URL}?${qs}&callback=${cb}`;

    const script = document.createElement("script");
    script.src = url;
    script.onerror = () => {
      try { delete window[cb]; } catch(e) { window[cb] = undefined; }
      script.remove();
      resolve({ ok:false, error:"No se pudo conectar (JSONP)" });
    };
    document.body.appendChild(script);
  });
}
function apiJSONP(action, params = {}) {
  return new Promise((resolve) => {
    const cb = "cb_" + Math.random().toString(36).slice(2);
    window[cb] = (data) => {
      try { resolve(data); }
      finally {
        delete window[cb];
        script.remove();
      }
    };

    const qs = new URLSearchParams({ action, callback: cb, ...params });
    const script = document.createElement("script");
    script.src = `${WEB_APP_URL}?${qs.toString()}`;
    script.onerror = () => {
      delete window[cb];
      script.remove();
      resolve({ ok:false, error:"No se pudo conectar (JSONP)" });
    };
    document.body.appendChild(script);
  });
}
(async ()=>{
 const res = await apiJSONP("listBarbers");
  const sel = $("barbero");
  sel.innerHTML = '<option value="">Selecciona…</option>';
  (res.barbers||[]).forEach(b=>{
    const o=document.createElement("option");
    o.value=b; o.textContent=b;
    sel.appendChild(o);
  });
})();

$("save").onclick = async ()=>{
  hide($("ok")); hide($("err"));

  const payload = {
    action:"setAvailability",
    pin: $("pin").value.trim(),
    barbero: $("barbero").value,
    fecha: $("fecha").value,
    start: $("start").value,
    end: $("end").value,
    interval: Number($("interval").value || 30),
    replace: $("replace").value === "true"
  };

  const res = await api(payload);
  if(res.ok) show($("ok"));
  else { show($("err")); $("err").textContent = "❌ " + (res.error||"Error"); }
};
</script>
</body>
</html>
